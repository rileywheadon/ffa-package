---
title: "Running the Complete Framework"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Running the Complete Framework}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette demonstrates how to use the master function `ffaframework` to perform a complete flood frequency analysis of a dataset under the assumption of nonstationarity.
Readers unfamiliar with the FFA framework should first consult the other vignettes.

## Case Study

This vignette will explore data from the Bow River at Banff (05BB001) hydrological monitoring station.
The remoteness of this station means that trends annual maxima are caused by changes in climate as opposed to changes in land use or cover.
Data for this station is provided as `CAN-05BB001.csv` in the `ffaframework` package.

```{r, fig.width = 10, fig.height = 8, fig.align = "center", out.width = "100%"}
library(ffaframework)

df <- data_local("CAN-05BB001.csv")
head(df)

plot_ams_data(df$max, df$year, title = "Bow River at Banff (05BB001)")
```

## The `ffaframework` Function

The `ffaframework` function is a complex but powerful tool which makes it possible to run the entire FFA framework and generate reproducible reports from a single line of code.
The function takes two mandatory arguments, `data` and `years`, as well as five optional arguments:

- `splits` is a list of years at which to split the data. If splits has $n$ elements, the data will be split into $n+1$ periods. Change point detection tests like the Pettitt test and MKS test can help inform the selection of split points.
- `structures` is a list of nonstationary structure objects for each period (see the *Nonstationary FFA* vignette for more information). Must satisfy `length(structures) == length(splits) + 1`.
- `automatic` is a logical scalar that specifies whether the framework should run in automatic mode. When the framework is in automatic mode, split points and nonstationary structures are chosen automatically based on the results of EDA.
- `path` is the path used to save the report. If set to `NULL` (default), the report is saved to a temporary directory generated using the `tempdir()` function.
- `formats` is a character vector used to specify the report format.

### Issues with Non-Interactive Mode

R can either run in *interactive mode* (e.g. RStudio, R console) or *non-interactive mode* (e.g. RScript). 
When R is run in non-interactive mode, it is not possible to select split points and nonstationary structures manually while using the `ffaframework` function.
Therefore, if you are running R in non-interactive mode, you *must* set `automatic = TRUE` OR set the `splits` and `structures` explicitly.

## Running the `ffaframework` in Automatic Mode

To run the framework in automatic mode, we can use: 

`ffaframework(df$max, df$year, automatic = TRUE)`

You can view the resulting report [here](report-automatic.html). 

From this report, we can see that the Pettitt test rejected the null hypothesis at the 0.05 significance level but would fail to reject the null hypothesis at the 0.01 significance level.
Additionally, the first plot, which shows the means of the 1909-1973 and 1974-2018 periods, shows that the change point identified by Pettitt test is very subtle.

## Running the `ffaframework` with Preset `splits` and `structure` 

Ultimately, deciding to split the data is the responsibility of the modeller.
For this case study, we have multiple good reasons for ignoring the change point identified by the Pettitt test:

1. The p-value is relatively high at 0.022.
2. A visual inspection of the data does not reveal a clear split point.
3. There is no geophysical reason that the Bow River at Banff station should have a split point.

Therefore, we will run the `ffaframework` function again, this time with no split points and a nonstationary structure that incorporates a trend in the mean.

`structure <- list(list(location = TRUE, scale = FALSE))`
`ffaframework(df$max, df$year, splits = numeric(0), structure = structure)`

You can view the resulting report [here](report-manual.html).


