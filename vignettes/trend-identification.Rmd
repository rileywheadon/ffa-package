---
title: "Trend Identification"
output: 
  rmarkdown::html_document:
    theme: readable
vignette: >
  %\VignetteIndexEntry{Trend Identification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Many factors can produce *nonstationarity* in annual maximum series (AMS) data, including changes in climate, land use/cover, and water management.
This vignette demonstrates how to use the `ffaframework` to check for evidence of nonstationarity.

## Overview

**Mean Trend Tests**

| Function            | Purpose                                                       |
|---------------------|---------------------------------------------------------------|
| `eda_mk_test`       | Tests for a monotonic trend (Mann-Kendall test).                   |
| `eda_bbmk_test`     | Tests for a monotonic trend under serial correlation (block-bootstrap MK test). |
| `eda_sens_trend`    | Estimates slope and intercept of a linear trend (Sen's slope estimator).|
| `eda_runs_test`     | Evaluates residuals' structure under linear model assumptions (Wald-Wolfowitz runs test).  |

 **Stationarity Tests**

| Function            | Purpose                                                       |
|---------------------|---------------------------------------------------------------|
| `eda_spearman_test` | Tests for serial correlation (Spearman test).                                 |
| `eda_kpss_test`     | Tests for a stochastic trend (KPSS test). |
| `eda_pp_test`       | Tests for a deterministic trend (Phillips-Perron test). |

**Variance Trend Tests**

| Function            | Purpose                                                       |
|---------------------|---------------------------------------------------------------|
| MW-MK Test           | Tests for a trend in the variability (moving-window MK test)                            |
| `eda_white_test`    | Tests for time-dependence in the variability (White test).   |

## Setup 

```{r setup}
library(ffaframework)

csv_path <- system.file("extdata", "Application_3.3.csv", package = "ffaframework")
df <- read.csv(csv_path)
df <- subset(df, !is.na(max)) # Remove missing values

head(df)
```

## Assessing Trends in the Mean

### Mann-Kendall (MK) Test

The MK test is a non-parametric test used to detect monotonic trends in a time series.
Under the null hypothesis, there is no trend.

Pass the AMS vector to `eda_mk_test()` to perform the MK test. 

```{r}
mk_test <- eda_mk_test(df$max)

print(mk_test$p_value)
```

**Conclusion**: A p-value of $1.4 \times 10^{-8}$ provides strong evidence of a trend in the mean.

### Spearman Test

The Spearman test is used to check for *serial correlation*, which can cause the MK test to identify a spurious trend.
The smallest lag at which the serial correlation is not statistically significant is known as the "least lag". 
If the least lag is greater than 1, apply the BBMK test to detect a monotonic trend under serial correlation.

```{r, fig.width = 10, fig.height = 8, fig.align = "center", out.width = "100%"}
spearman_test <- eda_spearman_test(df$max)

print(spearman_test$least_lag)

plot_spearman_test(spearman_test)
```

**Conclusion**: A least lag of 5 is evidence of serial correlation.
The BBMK test is needed to re-evaluate the presence of a monotonic trend.

### Block-Bootstrap Mann-Kendall (BBMK) Test

The BBMK test is a modified version of the MK test that accounts for serial correlation.
Under the null hypothesis, there is no trend.

```{r, fig.width = 10, fig.height = 8, fig.align = "center", out.width = "100%"}
bbmk_test <- eda_bbmk_test(df$max)

print(bbmk_test$p_value)

plot_bbmk_test(bbmk_test)
```

**Conclusion**: There is strong evidence of a monotonic trend in the data, even after accounting for serial correlation.

### Phillips-Perron Test

The Phillips-Perron test is used to evaluate whether a trend is *deterministic* or *stochastic*. 
Under the null hypothesis, the trend is stochastic (the data has a *unit root*).
It is important to check whether the trend type because a stochastic trend is nonlinear and not amenable to NS-FFA.

```{r}
pp_test <- eda_pp_test(df$max)


# NOTE: The PP-test rounds p-values below 0.01 to 0.01
print(pp_test$p_value)
```

**Conclusion**: At a p-value of <0.01, we reject the null hypothesis and conclude that the trend in the data is deterministic.
 
### KPSS Test

The KPSS test has the opposite hypotheses of the Phillips-Perron test.
Therefore, there is a deterministic trend under the null hypothesis and a stochastic trend under the alternative hypothesis.

```{r}
kpss_test <- eda_kpss_test(df$max)

# NOTE: The KPSS test rounds p-values above 0.1 to 0.1
print(kpss_test$p_value)
```

**Conclusion**: At a p-value of >0.10, we fail to reject the null hypothesis and conclude that the trend in the data is deterministic.

### Sen's Trend Estimator

While the previous tests confirm a significant monotonic trend, they do not estimate its magnitude.
We can estimate the monotonic trend using Sen's trend estimator, which uses a non-parametric approach that is robust to outliers.

`eda_sens_trend()` takes two arguments: the annual maximum series and the corresponding vector of years.

```{r, fig.width = 10, fig.height = 8, fig.align = "center", out.width = "100%"}
sens_trend <- eda_sens_trend(df$max, df$year)

plot_sens_trend(sens_trend, "mean")
```

**Conclusion**: Inspection of the data confirms the presence of a monotonic trend.

**Note**: The covariate is computed using the formula $(\text{years} - 1900) / 100$.

### Runs Test

The previous four statistical tests have assumed the nonstationarity is linear.
The Wald-Wolfowitz runs test assess the feasibility of the linearity assumption by checking the residuals for randomness.
If the residuals are random (the null hypothesis), there is evidence that the underlying trend is linear.

The `eda_runs_test()` function takes the output of `eda_sens_trend()` as an argument.

```{r, fig.width = 10, fig.height = 8, fig.align = "center", out.width = "100%"}
runs_test <- eda_runs_test(sens_trend)

print(runs_test$p_value)

plot_runs_test(runs_test, "mean")
```

**Conclusion**: At a p-value of $0.682$, there is evidence that a linear trend is suitable for the data.

## Trends in the Variance 

### Moving-Window Mann-Kendall (MWMK) Test

The MWMK test is used to detect trends in the variability of a time series.
First, a moving-window algorithm is used to estimate the variability of the AMS data.
Then, the Mann-Kendall test is applied to the series of standard deviations to check for a trend.

The `ams_mw_variance` estimates the moving-window standard deviations and the `eda_mk_test` function performs the Mann-Kendall test.

```{r}
mw <- ams_mw_variance(df$max, df$year)
mwmk_test <- eda_mk_test(mw$std)
print(mwmk_test$p_value)
```

**Conclusion**: At a p-value of 0.0024, there is evidence of a linear trend in the variability. 

### White Test

The White test checks for *heteroskedasticity*, or general time-dependence in the variability.
The null hypothesis is *homoskedasticity*, or constant variability in the data.

```{r}
white_test <- eda_white_test(df$max, df$year)
print(white_test$p_value)
```

**Conclusion**: At a p-value of 0.13, there is no evidence of heteroskedasticity. 

## Conclusion

- Even after adjusting for serial correlation, there is **evidence of nonstationarity in the mean of the AMS**.
- Additionally, the MWMK test provides **evidence of nonstationarity in the variability of the AMS**. 

Flood frequency analysis of this dataset requires a time-dependent probability model.

### Recommendation

Use NS-FFA.

